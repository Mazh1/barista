<!DOCTYPE html>

<html>
<head>
  <title>route.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="key.html">
                key.coffee
              </a>
            
              
              <a class="source" href="resource.html">
                resource.coffee
              </a>
            
              
              <a class="source" href="route.html">
                route.coffee
              </a>
            
              
              <a class="source" href="router.html">
                router.coffee
              </a>
            
              
              <a class="source" href="text.html">
                text.coffee
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>route.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>{ Key, Glob } = require <span class="string">'./key'</span>
{ Text }      = require <span class="string">'./text'</span>
{ Resource }  = require <span class="string">'./resource'</span>
inflection    = require <span class="string">'inflection'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap for-h1">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <h1>new Route( router, path [, method] )</h1>

            </div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>turns strings into magical ponies that come when you call them</p>
<pre><code>route = new Route(router, &#39;/:controller/:action/:id(.:format)&#39;)
route = new Route(router, &#39;/:controller/:action(/:id)(.:format)&#39;, &#39;GET&#39;)
route = new Route(router, &#39;/:controller/:action(/:id)(.:format)&#39;,
route = new Route(router, &#39;/:controller/:action/:id(.:format)&#39;, &#39;GET&#39;)</code></pre>
<p>Pretty familiar to anyone who&#39;s used Merb/Rails - called by Router.match()</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>exports.Route =
<span class="class"><span class="keyword">class</span> <span class="title">Route</span></span>
  constructor: ( router, path, method, <span class="property">@optional</span>=<span class="literal">false</span> )-&gt;
    <span class="keyword">if</span> router &amp;&amp; path
      <span class="property">@match</span>.apply <span class="keyword">this</span>, arguments</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <h2>route.match()</h2>

            </div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>the actual route builder function, mostly called by <code>new Route</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  match: ( router, path, method, <span class="property">@optional</span>=<span class="literal">false</span> )-&gt;

    <span class="keyword">if</span> <span class="keyword">typeof</span> path != <span class="string">'string'</span>
      <span class="keyword">throw</span> <span class="keyword">new</span> Error <span class="string">'path must be a string'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>is this a nested path?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span> <span class="property">@path</span>?
      prefix = <span class="property">@path</span></pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>get a list of key names in the new segment TODO: globs</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      new_keys = []
      new_keys.push <span class="string">':id'</span> <span class="keyword">if</span> <span class="property">@collection</span> || <span class="property">@member</span> <span class="comment"># force id to be renamed for resources</span>
      Array::push.apply new_keys, path.match RegExp(Key.regex.source, <span class="string">'g'</span>) <span class="comment"># find ALL</span></pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>rename earlier keys</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="keyword">for</span> key <span class="keyword">in</span> new_keys
        replKey = <span class="keyword">new</span> RegExp <span class="string">":(<span class="subst">#{key.substring(<span class="number">1</span>)}</span>/?)"</span>
        prefix = prefix.replace replKey, <span class="string">":<span class="subst">#{inflection.underscore inflection.singularize @params.controller}</span>_$1"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>return the new awesomeness</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="keyword">return</span> <span class="keyword">new</span> Route router, prefix+path, method, <span class="property">@optional</span></pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>uppercase the method name</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span> <span class="keyword">typeof</span>(method) == <span class="string">'string'</span>
      <span class="property">@method</span> = method.toUpperCase()</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>base properties</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="property">@params</span> = {}
    <span class="property">@parts</span> = []
    <span class="property">@route_name</span> = <span class="literal">null</span>
    <span class="property">@path</span> = path</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>@router = router</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    Object.defineProperty <span class="keyword">this</span>, <span class="string">'router'</span>, <span class="comment"># exclude in enumerables</span>
      enumerable: <span class="literal">false</span>
      configurable: <span class="literal">false</span>
      writable: <span class="literal">false</span>
      value: router

    <span class="property">@parts</span> = Route.parse router, path, method, <span class="property">@optional</span></pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>reset the path to the generated one (chop off any extra )&#39;s )</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="property">@path</span> = <span class="property">@toString</span>()

    <span class="keyword">unless</span> <span class="property">@optional</span>
      <span class="property">@router</span>.routes.push <span class="keyword">this</span>

    <span class="keyword">this</span></pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <h2>convenience methods</h2>

            </div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <h3>route.get( path )</h3>
<p>equivalent to</p>
<pre><code>route.match( path, &#39;GET&#39; )</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre>  get: ( path )-&gt;
    <span class="property">@match</span> <span class="property">@router</span>, path, <span class="string">'GET'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <h3>route.put( path )</h3>
<p>equivalent to</p>
<pre><code>route.match( path, &#39;PUT&#39; )</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre>  put: ( path )-&gt;
    <span class="property">@match</span> <span class="property">@router</span>, path, <span class="string">'PUT'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <h3>route.post( path )</h3>
<p>equivalent to</p>
<pre><code>route.match( path, &#39;POST&#39; )</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre>  post: ( path )-&gt;
    <span class="property">@match</span> <span class="property">@router</span>, path, <span class="string">'POST'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <h3>route.patch( path )</h3>
<p>equivalent to</p>
<pre><code>route.match( path, &#39;PATCH&#39; )</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre>  patch: ( path )-&gt;
    <span class="property">@match</span> <span class="property">@router</span>, path, <span class="string">'PATCH'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <h3>route.del( path )</h3>
<p>equivalent to</p>
<pre><code>route.match( path, &#39;DELETE&#39; )</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre>  del: ( path )-&gt;
    <span class="property">@match</span> <span class="property">@router</span>, path, <span class="string">'DELETE'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <h2>route.resource( controller )</h2>

            </div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>generates standard resource routes for a controller name</p>
<pre><code>route.resource(&#39;products&#39;)</code></pre>
<p>returns a Resource object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  resource: ( controller )-&gt;
    <span class="keyword">new</span> Resource <span class="keyword">this</span>, controller</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <h2>route.regexString()</h2>

            </div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>returns a composite regex string of all route parts</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  regexString: -&gt;
    ret = <span class="string">''</span></pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>a route regex is a composite of its parts&#39; regexe(s|n)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">for</span> part <span class="keyword">in</span> <span class="property">@parts</span>
      ret += <span class="keyword">if</span> part.regexString <span class="keyword">then</span> part.regexString() <span class="keyword">else</span> regExpEscape part

    <span class="string">"(<span class="subst">#{ret}</span>)<span class="subst">#{<span class="keyword">if</span> @optional <span class="keyword">then</span> '?' <span class="keyword">else</span> ''}</span>"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <h2>route.test( string )</h2>

            </div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>builds &amp; tests on a full regex of the entire path</p>
<pre><code>route.test( &#39;/products/19/edit&#39; )
 =&gt; true</code></pre>
<p>returns true/false depending on whether the url matches</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  test: ( string )-&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>cache the regex string</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="property">@regex</span> ?= RegExp <span class="string">"^<span class="subst">#{@regexString()}</span>(\\\?.*)?$"</span>

    <span class="property">@regex</span>.test string</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <h2>route.to( endpoint [, extra_params ] )</h2>

            </div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>defines the endpoint &amp; mixes in optional params</p>
<pre><code>route.to( &#39;controller.action&#39; )

route.to( &#39;controller.action&#39;, {lang:&#39;en&#39;} )</code></pre>
<p>returns the route for chaining</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  to: ( endpoint, extra_params )-&gt;

    <span class="keyword">if</span> !extra_params &amp;&amp; <span class="keyword">typeof</span> endpoint != <span class="string">'string'</span>
      extra_params = endpoint
      endpoint = <span class="literal">undefined</span></pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>TODO: make endpoint optional, since you can have the
controller &amp; action in the URL utself,
even though that&#39;s a terrible idea...</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span> endpoint
      endpoint = endpoint.split <span class="string">'.'</span>
      <span class="keyword">if</span> kindof(endpoint) == <span class="string">'array'</span> &amp;&amp; endpoint.length != <span class="number">2</span>
        <span class="keyword">throw</span> <span class="keyword">new</span> Error <span class="string">'syntax should be in the form: controller.action'</span>
      <span class="property">@params</span>.controller = endpoint[<span class="number">0</span>]
      <span class="property">@params</span>.action = endpoint[<span class="number">1</span>]

    extra_params = {} <span class="keyword">unless</span> kindof(extra_params) == <span class="string">'object'</span>

    mixin <span class="property">@params</span>, extra_params

    <span class="keyword">this</span> <span class="comment"># chainable</span></pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <h2>route.name( name )</h2>

            </div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>just sets the route name - NAMED ROUTES ARE NOT CURRENTLY USED</p>
<pre><code>route.name( &#39;login&#39; )
route.name( &#39;homepage&#39; ) # etc...</code></pre>
<p>returns: the route for chaining</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  name: ( name )-&gt;
    <span class="property">@route_name</span> = name
    <span class="keyword">this</span> <span class="comment"># chainable</span></pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <h2>route.where( conditions )</h2>

            </div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>sets conditions that each url variable must match for the URL to be valid</p>
<pre><code>route.where( { id:/\d+/, username:/\w+/ } )</code></pre>
<p>returns: the route for chaining</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  where: ( conditions )-&gt;
    <span class="keyword">if</span> kindof(conditions) != <span class="string">'object'</span>
      <span class="keyword">throw</span> <span class="keyword">new</span> Error <span class="string">'conditions must be an object'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>recursively apply all conditions to sub-parts</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    part.where? conditions <span class="keyword">for</span> part <span class="keyword">in</span> <span class="property">@parts</span>
    <span class="keyword">this</span> <span class="comment"># chainable</span></pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <h2>route.stringify( params )</h2>

            </div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>builds a string url for this Route from a params object</p>
<p>returns: [ &quot;url&quot;, [leftover params] ]</p>
<p><strong>this is meant to be called &amp; modified by router.url()</strong></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  stringify: ( params )-&gt;
    url = [] <span class="comment"># urls start life as an array to enable a second pass</span>
    <span class="keyword">for</span> part <span class="keyword">in</span> <span class="property">@parts</span>
      <span class="keyword">if</span> part <span class="keyword">instanceof</span> Key || part <span class="keyword">instanceof</span> Glob
        <span class="keyword">if</span> params[part.name]? &amp;&amp; part.regex.test params[part.name]</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>there&#39;s a param named this &amp;&amp; the param matches the key&#39;s regex</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          url.push part.url params[part.name] <span class="comment"># push it onto the stack</span>
          <span class="keyword">delete</span> params[part.name]</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p><code>delete params[part.name]</code> # and remove from list of params</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">else</span> <span class="keyword">if</span> <span class="property">@optional</span></pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>(sub)route doesn&#39;t match, move on</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="keyword">return</span> <span class="literal">false</span>
      <span class="keyword">else</span> <span class="keyword">if</span> part <span class="keyword">instanceof</span> Route</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>sub-routes must be handled in the next pass
to avoid leftover param duplication</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        url.push part
      <span class="keyword">else</span> <span class="comment"># string</span>
        url.push part</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>second pass, resolve optional parts (backwards, so later optionals are resolved first)
for i=url.length-1; i&gt;=0; i--</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">for</span> part, i <span class="keyword">in</span> url <span class="keyword">by</span> -<span class="number">1</span>
      <span class="keyword">if</span> part <span class="keyword">instanceof</span> Route
        part = part.stringify params <span class="comment"># recursion is your friend</span></pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>it resolved to a url fragment!</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">if</span> part
          params = part[<span class="number">1</span>] <span class="comment"># replace leftover params hash with the new, smaller leftover params hash</span>
          url[i] = part = part[<span class="number">0</span>] <span class="comment"># leave only the string for joining</span>
        <span class="keyword">else</span>
          <span class="keyword">delete</span> url[i] <span class="comment"># get rid of these shits</span>

    <span class="keyword">for</span> key, val <span class="keyword">of</span> <span class="property">@params</span></pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>remove from leftovers, they&#39;re implied in the to() portion of the route</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="keyword">delete</span> params[key]

    [ url.join(<span class="string">''</span>), params ]</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <h2>route.keysAndRoutes()</h2>

            </div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>just the parts that aren&#39;t strings. basically</p>
<p>returns an array of Key and Route objects</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  keysAndRoutes: -&gt;
    <span class="property">@parts</span>.filter (part)-&gt;
      part <span class="keyword">instanceof</span> Key || part <span class="keyword">instanceof</span> Glob || part <span class="keyword">instanceof</span> Route</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <h2>route.keys()</h2>

            </div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>just the parts that are Keys (or globs)</p>
<p>returns an array of aforementioned Keys</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  keys: -&gt;
    <span class="property">@parts</span>.filter (part)-&gt;
      part <span class="keyword">instanceof</span> Key || part <span class="keyword">instanceof</span> Glob</pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <h2>route.parse( url, method )</h2>

            </div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p>parses a URL into a params object</p>
<pre><code>route.parse( &#39;/products/15/edit&#39;, &#39;GET&#39; )
 =&gt; { controller:&#39;products&#39;, action:&#39;edit&#39;, id:15 }</code></pre>
<p>returns: a params hash || false (if the route doesn&#39;t match)</p>
<p><strong>this is meant to be called by Router.first() &amp;&amp; Router.all()</strong></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  parse: ( urlParam, method )-&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>parse the URL with the regex &amp; step along with the parts,
assigning the vals from the url to the names of the keys as we go (potentially stoopid)</p>
<p>let&#39;s chop off the QS to make life easier</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    url =     require(<span class="string">'url'</span>).parse urlParam <span class="comment"># TODO: fix this</span>
    path =    decodeURI url.pathname
    params =  { method: method }

    mixin params, <span class="property">@params</span></pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p>route HEAD requests to GET endpoints</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    head = params.method == <span class="string">'HEAD'</span>
    <span class="keyword">if</span> head
      params.method = <span class="string">'GET'</span> <span class="comment"># we'll put it back when we're done</span></pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <p>if the method doesn&#39;t match, gtfo immediately</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span> <span class="property">@method</span>? &amp;&amp; params.method?
      <span class="keyword">if</span> <span class="property">@method</span> != params.method
        <span class="keyword">return</span> <span class="literal">false</span></pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <p>assign the route&#39;s method if there isn&#39;t one</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    params.method ?= <span class="property">@method</span></pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <p>TODO: implement substring checks for possible performance boost</p>
<p>if the route doesn&#39;t match the regex, gtfo</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">return</span> <span class="literal">false</span> <span class="keyword">unless</span> <span class="property">@test</span> path</pre></div></div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <p>parse the URL with the regex
slice(2) returns just the array of matches from the regexp object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    parts = <span class="keyword">new</span> RegExp(<span class="string">"^<span class="subst">#{@regexString()}</span>$"</span>).exec(path).slice(<span class="number">2</span>)
    keysAndRoutes = <span class="property">@keysAndRoutes</span>()
    pairings = []</pre></div></div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              <p>loop 1 (forwards) - collect the key/route -&gt; part pairings for loop 2</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    `<span class="javascript">
    <span class="keyword">for</span> (<span class="keyword">var</span> i=<span class="number">0</span>, j=<span class="number">0</span>; i&lt;keysAndRoutes.length; i++, j++) {
      <span class="keyword">var</span> part = parts[j]
        , segm = keysAndRoutes[i]

      <span class="comment">// if this part doesnt match the segment, move on</span>
      <span class="keyword">if</span> ( segm.test(part) ) { <span class="comment">// !! testing builds a regex if we didn't have one before</span>
        <span class="comment">// stash the pairings for loop 2</span>
        pairings.push( [ segm, part ] )
      }

      <span class="comment">// routes must advance the part iterator by the number of parts matched in the segment</span>
      j+= ( segm.regex.exec(part||<span class="string">''</span>).slice(<span class="number">2</span>).length || <span class="number">1</span> ) - <span class="number">1</span>
    }
    </span>`</pre></div></div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
              <p>loop 2 (backwards) - parse the key/route -&gt; part pairings (backards so later optional matches are preferred)
i.e. /path(.:format)/something(.:format) would keep the last format segment, while discarding the first
this makes life easier for nesting route definitions</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">for</span> pair <span class="keyword">in</span> pairings <span class="keyword">by</span> -<span class="number">1</span>
      part = pair[<span class="number">1</span>]
      segm = pair[<span class="number">0</span>]</pre></div></div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-59">&#182;</a>
              </div>
              <p>actually mixin the params</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="keyword">if</span> segm <span class="keyword">instanceof</span> Key || segm <span class="keyword">instanceof</span> Glob
        params[segm.name] = part
      <span class="keyword">else</span> <span class="keyword">if</span> segm <span class="keyword">instanceof</span> Route
        mixin params, segm.parse(part, method)</pre></div></div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-60">&#182;</a>
              </div>
              <p>replace HEAD method?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    params.method = <span class="string">'HEAD'</span> <span class="keyword">if</span> head

    params



  nest: ( cb )-&gt;
    <span class="keyword">unless</span> <span class="keyword">typeof</span> cb == <span class="string">'function'</span>
      <span class="keyword">throw</span> <span class="keyword">new</span> Error <span class="string">'route.nest() requires a callback function'</span>
    cb.call <span class="keyword">this</span>
    <span class="keyword">this</span> <span class="comment"># for chaining</span></pre></div></div>
            
        </li>
        
        
        <li id="section-61">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-61">&#182;</a>
              </div>
              <h2>route.toString()</h2>

            </div>
            
        </li>
        
        
        <li id="section-62">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-62">&#182;</a>
              </div>
              <p>returns the original route definition</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  toString: -&gt;
    defn = <span class="property">@parts</span>.reduce (m=<span class="string">''</span>,part)-&gt; m+part.toString()
    <span class="keyword">if</span> <span class="property">@optional</span>
      <span class="string">"(<span class="subst">#{ defn }</span>)"</span>
    <span class="keyword">else</span></pre></div></div>
            
        </li>
        
        
        <li id="section-63">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-63">&#182;</a>
              </div>
              <p>toString() again just in case the callback never fired
see <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/Reduce">https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/Reduce</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      defn.toString()</pre></div></div>
            
        </li>
        
        
        <li id="section-64">
            <div class="annotation">
              
              <div class="pilwrap for-h1">
                <a class="pilcrow" href="#section-64">&#182;</a>
              </div>
              <h1>Route.parse( router, string, method, optional=false )</h1>

            </div>
            
        </li>
        
        
        <li id="section-65">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-65">&#182;</a>
              </div>
              <p>parses a route definition into a swiss army bazooka</p>
<pre><code>route = Route.parse(router, &#39;/:controller/:action/:id(.:format)&#39;)
route = Route.parse(router, &#39;/:controller/:action(/:id)(.:format)&#39;, &#39;GET&#39;)
route = Route.parse(router, &#39;/:controller/:action(/:id)(.:format)&#39;,
route = Route.parse(router, &#39;/:controller/:action/:id(.:format)&#39;, &#39;GET&#39;)</code></pre>
<p>Pretty familiar to anyone who&#39;s used Merb/Rails - called by Router.match()</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Route.<span class="function"><span class="title">parse</span></span> = ( router, string, method, optional=<span class="literal">false</span> )-&gt;
  parts = []</pre></div></div>
            
        </li>
        
        
        <li id="section-66">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-66">&#182;</a>
              </div>
              <p>parse it char by char, baby</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">for</span> char, i <span class="keyword">in</span> string</pre></div></div>
            
        </li>
        
        
        <li id="section-67">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-67">&#182;</a>
              </div>
              <p>special consideration for Ogrp starts</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span> char == <span class="string">'('</span> &amp;&amp; i==<span class="number">0</span>
      <span class="keyword">continue</span> <span class="comment"># skip this char, since it's not strictly part of the route definition</span></pre></div></div>
            
        </li>
        
        
        <li id="section-68">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-68">&#182;</a>
              </div>
              <p>the route definition is over, return what we have</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span> char == <span class="string">')'</span>
      <span class="keyword">return</span> parts

    <span class="keyword">if</span> char == <span class="string">':'</span> &amp;&amp; string[i+<span class="number">1</span>] != <span class="string">':'</span>
      parts.push Key.parse string[i..]
    <span class="keyword">else</span> <span class="keyword">if</span> char == <span class="string">'*'</span>
      parts.push Glob.parse string[i..]
    <span class="keyword">else</span> <span class="keyword">if</span> char == <span class="string">'('</span>
      parts.push <span class="keyword">new</span> Route router, string[i..], method, <span class="literal">true</span>
    <span class="keyword">else</span>
      parts.push Text.parse string[i..]

    <span class="keyword">if</span> parts[parts.length-<span class="number">1</span>].toString().length
      _i = i + parts[parts.length-<span class="number">1</span>].toString().length - <span class="number">1</span>

  parts</pre></div></div>
            
        </li>
        
        
        <li id="section-69">
            <div class="annotation">
              
              <div class="pilwrap for-h1">
                <a class="pilcrow" href="#section-69">&#182;</a>
              </div>
              <h1>Helper methods</h1>

            </div>
            
        </li>
        
        
        <li id="section-70">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-70">&#182;</a>
              </div>
              <p>deep object mixer</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">mixin</span></span> = ( ret, mixins... )-&gt;
  <span class="keyword">for</span> obj <span class="keyword">in</span> mixins
    <span class="keyword">for</span> own key, val <span class="keyword">of</span> obj
      <span class="keyword">if</span> kindof(val) == <span class="string">'object'</span>
        ret[key] = mixin {}, val
      <span class="keyword">else</span>
        ret[key] = val
  ret</pre></div></div>
            
        </li>
        
        
        <li id="section-71">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-71">&#182;</a>
              </div>
              <p>better than typeof</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">kindof</span></span> = ( o )-&gt;
  <span class="keyword">switch</span>
    <span class="keyword">when</span> <span class="keyword">typeof</span> o != <span class="string">"object"</span>     <span class="keyword">then</span> <span class="keyword">typeof</span> o
    <span class="keyword">when</span> o == <span class="literal">null</span>                <span class="keyword">then</span> <span class="string">"null"</span>
    <span class="keyword">when</span> o.constructor == Array   <span class="keyword">then</span> <span class="string">"array"</span>
    <span class="keyword">when</span> o.constructor == Date    <span class="keyword">then</span> <span class="string">"date"</span>
    <span class="keyword">when</span> o.constructor == RegExp  <span class="keyword">then</span> <span class="string">"regex"</span>
    <span class="keyword">else</span> <span class="string">"object"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-72">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-72">&#182;</a>
              </div>
              <p>escape a string for literal embedding in a regexp</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>regExpEscape = <span class="keyword">do</span> -&gt;
  specials = [ <span class="string">'/'</span>, <span class="string">'.'</span>, <span class="string">'*'</span>, <span class="string">'+'</span>, <span class="string">'?'</span>, <span class="string">'|'</span>, <span class="string">'('</span>, <span class="string">')'</span>, <span class="string">'['</span>, <span class="string">']'</span>, <span class="string">'{'</span>, <span class="string">'}'</span>, <span class="string">'\\'</span> ]
  sRE = <span class="keyword">new</span> RegExp <span class="string">"(\\<span class="subst">#{ specials.join '|\\' }</span>)"</span>, <span class="string">'g'</span>
  ( text )-&gt; text.replace sRE, <span class="string">'\\$1'</span></pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
